generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String        @id @default(uuid())
  email              String        @unique
  password           String
  fullName           String
  role               String        @default("KLIEN")
  phone              String?
  address            String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  logs               ActivityLog[]
  uploads            Document[]
  accountantOrders   Order[]       @relation("AccountantOrders")
  clientOrders       Order[]       @relation("ClientOrders")
  revisionsRequested Revision[]    @relation("RevisionRequester")
  revisionsAssigned  Revision[]    @relation("RevisionAssignee")
}

model ServicePackage {
  id          String   @id @default(uuid())
  name        String
  description String
  price       Decimal
  duration    String?
  category    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      Order[]
}

model Order {
  id            String         @id @default(uuid())
  status        String         @default("PENDING_PAYMENT")
  totalAmount   Decimal
  notes         String?
  revisionCount Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  clientId      String
  accountantId  String?
  serviceId     String
  documents     Document[]
  revisions     Revision[]
  service       ServicePackage @relation(fields: [serviceId], references: [id])
  accountant    User?          @relation("AccountantOrders", fields: [accountantId], references: [id])
  client        User           @relation("ClientOrders", fields: [clientId], references: [id])
  payment       Payment?
}

model Document {
  id         String   @id @default(uuid())
  fileName   String
  fileUrl    String
  fileType   String
  isResult   Boolean  @default(false)
  uploadedAt DateTime @default(now())
  orderId    String
  uploaderId String
  uploader   User     @relation(fields: [uploaderId], references: [id])
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model Payment {
  id            String    @id @default(uuid())
  amount        Decimal
  status        String    @default("UNPAID") // UNPAID, PENDING_APPROVAL, APPROVED, REJECTED
  paymentMethod String?
  proofUrl      String?
  paidAt        DateTime?
  approvedBy    String?
  approvedAt    DateTime?
  createdAt     DateTime  @default(now())
  orderId       String    @unique
  order         Order     @relation(fields: [orderId], references: [id])
}

model Revision {
  id      String @id @default(uuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  requestedBy String
  requester   User   @relation("RevisionRequester", fields: [requestedBy], references: [id])

  assignedTo String?
  assignee   User?   @relation("RevisionAssignee", fields: [assignedTo], references: [id])

  title       String
  description String
  status      String @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, REJECTED

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
}

model ActivityLog {
  id         String   @id @default(uuid())
  action     String
  type       String   @default("INFO") // CREATE, UPDATE, DELETE, LOGIN, etc.
  resource   String   @default("SYSTEM") // Order, User, Service, etc.
  resourceId String?
  details    Json?    // Flexible JSON for extra details
  severity   String   @default("INFO") // INFO, WARNING, ERROR, CRITICAL
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
}

model Settings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
